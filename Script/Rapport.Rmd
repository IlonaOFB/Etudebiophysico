---
title: "Rapport de stage"
output: html_document 
toc : true
toc_depth: 4
date: "2025-06-02"
editor_options: 
  markdown: 
    wrap: 72
---

# Présentation de la structure

## a) Présentation générale

L'Office Français de la Biodiversité (OFB) est un établissement public
français créé le 1er janvier 2020. L'Office National de la Chasse et de
la Faune Sauvage (ONCFS), créé en 2000, s'est uni à l'Agence Française
de la Biodiversité, créé en 2017. L'OFB met en oeuvre des actions visant
à la protection et la à restauration de la biodiversité terrestre et
marine.

Les agents s'engagent dans la lutte contre les cinq causes majeures de
la dégradation de la biodiversité : la destruction et la fragmentation
des milieux naturels, les pollutions, la surexploitation des ressources,
l'introduction d'espèces exotiques envahissantes et les conséquences du
changement climatique (IPBES,2019). Les services de l'OFB s'articulent
également autour des missions complémentaires suivantes : la police de
l'environnement; la connaissance/recherche et l'expertise sur les
espèces, leurs milieux et leurs usages; l'appui à la mise en oeuvre des
politiques publique; la gestion et l'appui aux gestionnaires d'espaces
naturels et pour terminer l'appui aux acteurs et à la mobilisation de la
société.

## b) OFB Bretagne

La Direction Régionale Bretagne de l'OFB regroupe 130 agents répartis
sur toute la région. Trois services sont établis dans ses locaux :
"Appui aux acteurs et mobilisation des territoires", "Police" et
"Connaissance". Le présent stage se déroule dans le service
Connaissance, sous la tutelle d'Yves-Marie (chef adjoint du service
connaissance) , Thibault Vigneron (chef du service connaissance) et
Pascal Irz (ingénieur connaissance).

# Introduction

# Contexte général

## Les pressions anthropiques en milieux d’eau douce

Les cours d’eau subissent des pressions d’origine hydromorphologique et
polluante, qui entraînent de nombreuses dégradations sur l’état des
milieux aquatiques, incluant les populations qui les peuplent. Depuis le
développement des industries, de l’agriculture intensive et
l’urbanisation à partir au XIX siècle, l’intensité des perturbations n’a
cessé d’augmenter.

Ces milieux sont notamment soumis à des modifications morphologiques
profondes telles que la chenalisation, l’artificialisation des berges,
l’altération des régimes hydrologiques naturels, l’exploitation du lit
du cours d’eau et le drainage des terres ainsi que des zones humides.
Ces altérations peuvent avoir des conséquences significatives sur
l’habitat et le fonctionnement global de l’écosystème.

A cela s’ajoute la pollution chimique, issue de rejets d’origines
multiples. Elles peuvent être diffuses ou ponctuelles. En Bretagne,
seulement 51% des cours d’eau sont en bon état chimique, en ne prenant
en compte que les 53 substances prioritaires non ubiquistes. D’après les
données de 2022 de l'OEB, 59% des masses d’eau sont concernés par les
pollutions diffuses, dont les pesticides, phosphore et nitrates
respectivement 57%, 15% et 12% (chiffres clés de l’eau en Bretagne,
2023).

**[Parler des interactions entre Nitrates et autres formes de l’azote,
PTOT ? ] [Micro-polluants ?] [Parler du changement climatique ?]**

L’état d’un milieu aquatique peut s’appréhender sous différents angles,
notamment écologique et biologique. C’est dans cette optique qu’a été
instaurée en 2000 la Directive Cadre sur l’Eau (DCE) par le Conseil
européen et le conseil des ministres, intégrant la notion de
bio-indication dans la méthodologie d’évaluation de l’état des milieux
aquatiques. La DCE vise à prévenir et réduire la pollution des eaux, à
promouvoir leur utilisation durable et améliorer l'état des écosystèmes
aquatiques. Elle constitue également un cadre visant à gérer et protéger
les eaux européennes. Les états membres sont dans l’obligation d’évaluer
la qualité écologique de leurs masses d’eau et de restaurer ou maintenir
leur bon état écologique d’ici 2027. Les éléments de qualité biologiques
(EQB) retenues sont : les poissons, les macrophytes, les
macro-invertébrés et les diatomées. Cette évaluation de l’état d’un
milieu est permise grâce à une classifications qui distingues les cours
d’eau de références, définis comme ceux présentant les caractéristiques
attendues en l’absence de pression humaines (concept de « conditions de
référence » ; Bailey et al. 1998 et les cours d’eau altérés). La notion
d’écart à un état de référence est intégrée dans le calcul des indices
biologiques, et par conséquent dans l’évaluation de l’état écologique
des masses d’eau, ils seront alors traduits en ratios de qualités
biologiques. Les stations sont classées de la manière suivante : réseau
de référence pérenne (RRP), réseau de contrôle de surveillance (RCS),
réseau de contrôle opération (RCO).

En Bretagne, les trois-quarts des masses d’eau sont déclassés en raison
de leur mauvaise qualité biologique. Les diatomées sont le deuxième
groupe de bio-indicateur déclassant en Bretagne, suivi par les
macroinvertébrés. Parmi les masses d’eau bretonnes, 55% d’entre elles
sont classées comme médiocres par rapport aux paramètres
physico-chimique soutenant l’état-écologique.

Source : <https://pastel.hal.science/pastel-00879788> Source :
bioindication-outils-d-evaluation_0.pdf Allan, 2004; Bader and Baccini,
1993)

## Les éléments de qualité biologique étudiés

La bioévaluation permet la détermination de l'état d'un milieux, en
s'appuyant sur des indicateurs biologiques. Ces indicateurs
correspondent à des espèces biologiques ou animales, dont la présence,
l'abondance ou l'état de santé reflète des modifications biotiques ou
abiotiques de l'environnement dues à des activités humaines
(<https://eau-grandsudouest.fr/glossaire/b>).

### L’Indice invertébrés multi-métriques

Selon la définition de Cummins (1975), les macroinvertébrés sont des
organismes dont la taille atteint au moins 3 à 5 mm au dernier stade de
leur développement. Cette définition inclut donc à la fois les jeunes
stades des macroinvertébrés et les derniers stades des micro-invertébrés
(Tachet). Ils sont présents dans tous les écosystèmes aquatiques,
certains sont holobiotiques et d'autres amphibiotiques. Ils regroupent
une grande variété de genres et espèces, dont la plupart sont
indicatrices telles que : les ephéméroptères, plécoptères et
trichoptères (EPT).

Les macroinvertébrés jouent un rôle essentiel dans les écosystèmes
aquatiques en contribuant notamment à la transformation de la matière
organique (accélération du cycle des nutriments), en servant de
nourriture pour les poissons et en étant des indicateurs de pollution.
En effet, ils regroupent un grand nombre de taxons ayant différents
niveaux de tolérance à la pollution. Leur courte durée de génération
permet aux communautés de réagir rapidement aux changements
environnementaux. Certaines différences dans leurs cycles de vie, leurs
caractéristiques physiologiques, leur mobilité et leur sensibilité
individuelle à la pollution sont à l'origine de la construction
d’indices basés sur les macroinvertébrés (Marzin et al., 2012 ; Alric et
al., 2021). Parmi les éléments de qualité biologique (EQB), les
indicateurs basés sur les macroinvertébrés sont les plus sensibles aux
dégradations globales des cours d’eau
(<https://pastel.hal.science/pastel-00879788>).

L'indice I2M2 permet d'évaluer la qualité écologique sur la base d'un
écart à une référence, résultat en EQR (*Ecological quality ratio*).
Cela implique donc d'établir des peuplements de référence par type de
cours d'eau, et donc d'un réseau de référence. Ceux-ci sont seIectionnés
sur la base de la taille du cours d'eau correspondant et de leur
hydro-écorégion. L'indice est conçu pour identifier les tronçons de
cours d'eau dégradés en lien avec 17 catégories de pressions
anthropiques. Deux catégories de pressions sont prises en considération
: pressions liées à la dégradation de la qualité de l’eau et celles
liées à la dégradation de l’habitat. L’I2M2 prend en compte les
caractéristiques taxonomiques et les traits biologiques des communautés
de macroinvertébrés benthiques, avec une détermination des individus
jusqu’au genre (et non plus seulement à la famille, ce qui était le cas
avec l’IBGN). De plus, il intègre les abondances des genres recensés.
L’échantillonnage est réalisé selon la norme NF T 90-333 dans l’AFNOR,
2016.

Les métriques retenues pour la construction de l’indice sont les
suivantes :

-   Indice de diversité de Shannon

-   Richesse taxonomique

-   Score ASPT (Average Score Per Taxon)

-   Abondance relative de taxons polyvoltinistes

-   Abondance relative de taxons ovovivipares

A noter que les deux premières métriques reflètent davantage une qualité
de l'habitat, tandis que les suivantes sont plus représentatives de la
qualité physico-chimique des masses d'eau. [mettre source]

### L’Indice biologique diatomées

Les diatomées sont des algues brunes unicellulaires microscopiques,
mesurant 5µm à 500µm. Elles appartiennent à l'embranchement des
Chromophytes. Elles sont constituées d'un frustule siliceux et de
matière organique végétale. Parmi les critères qui en font de bon
bio-indicateurs : cycle de vie rapide (efficace pour les impacts qui ont
lieu sur une courte durée), caractère cosmopolite, grande diversité,
sensibilité variable à la pollution, échantillonage aisé, conservation
en laboratoire facile.

Leur croissance est directement influencée par la température,
l'intensité lumineuse, les caractéristiques hydrauliques et
physico-chimiques. Les paramètres physico-chimiques influençant les
diatomées sont : le pH, les nutriments (azotés et phosphorés), la
présence de matière organique et une faible oxygénation en eaux. D'après
l'étude (conductiv/ph), elles sont également sensibles à la
conductivité. A mesure que la conductvité augmente, les espèces
tolérantes à la conductivité élevée remplacent celles qui sont moins
tolérantes.

L'IBD correspond à une valeur calculée à partir d'une analyse de la
flore diatomique benthique d'un cours d'eau de France métropolitaine,
selon la norme NF T90-354, avril 2016 (SANDRE). Il évalue plus
particulièrement le niveau de pollution organique (saprobie) et
trophique (nutriments azotés et phosphorés). Il prend en compte
l'abondance de 209 taxons appariés, leur sensibilité à la pollution et
leur faculté à s'adapter à différents milieux. A noter que l'indice de
polluo-sensibilité spécifique, prend en compte la totalité des espèces
présentes dans les inventaires et se base sur l'abondance relative ainsi
que leur sensibilité à la pollution.

<https://acces.ens-lyon.fr/acces/thematiques/biodiversite/dossiers-thematiques/biosurveillance-et-bioindicateurs/les-diatomees-bio-indicatrices-de-la-qualite-des-cours-d2019eau>

# Contexte de l’étude

## Zone d’étude

La Bretagne est une région située au nord-ouest de la France. Son climat
est marqué par un gradient ouest-est. Les précipitations y sont
relativement abondantes à l’ouest, sous l’influence du climat océanique
contrairement à l’est du territoire, où la pluviométrie y est deux fois
moindre. En ce qui concerne la géologie, c’est un massif ancien, drainé
par un réseau hydrographique d’environ 30 000 kilomètres (IBG, 2017). Au
sens de la DCE, l’état des cours d’eau est très contrasté sur la
Bretagne entre le département du Finistère (61% en bon état) et
l’Ille-et-Vilaine (2% en bon état). A l'ouest de la Bretagne, la forte
pente et la diversité morphologique des cours d'eau renforcent leur
capacité de résilience. A l'inverse, en Ille-et-Vilaine, le déficit
pluviométrique limite les débits, réduisant ainsi la capacité de
dilution et d'autoépuration. Les principales pressions expliquant la non
atteinte au bon état écologique des cours d'eeau en Bretagne sont la
dégradation de la morphologie des cours d'eau, ainsi que
l'intensification de l'agriculture laitière au sud de Rennes.

[![Carte de l'état écologique des masses d'eau de type "cours d'eau" en
Bretagne,
OEB](images/carte%20bretagne.jpg){width="682"}](https://bretagne-environnement.fr/sites/default/files/cartes/images/carte_etat_ecologique_masses_eau_cours_eau_2015_2017_bretagne_oeb.jpg)

## Le phosphore et les nitrates dans les cours d’eau bretons

Malgré les améliorations, la concentration en phosphore reste élevée
dans la majorité des cours d’eau bretons. Celle-ci est de 0,31 mg.L
(percentile 90), émis notamment par les activités agricoles, le
phosphore est largement transféré dans les cours d’eau pendant la
période hivernale, où les pluies sont plus intenses. Le phosphore
provenant d’industrie ou autre activité urbaine, est rejeté toute
l’année, devenant alors une pollution diffuse continue. Cet apport
devient d'autant plus majeur en période sèche. Un léger gradient de
concentration, et donc de qualité, au regard des espèces phosphorées,
s'exerce en Bretagne.

Plusieurs études ont montré la pertinence du phosphore total pour
l'étude réponses biologiques des macro-invertébrés et autres indicateurs
biologiques, notamment au niveau des sites les plus pollués.
(<https://www.sciencedirect.com/science/article/pii/S0048969723066214?via%3Dihub>)

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height=5, fig.align = 'center', fig.cap= " Fig.2 : Gradient de concentration en phosphore total en Bretagne, autrice : Ilona Garcia "}

load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/80_donnees_globales_trans.rda")
load(file = "../Data/90_acp.rda")
load(file ="../Data/40_statistiques_descriptives.rda")

library(sf)
library(dplyr)
library(ggspatial)
library(ggplot2)
remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)

p90 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P90 = quantile(resultat, probs = 0.9, na.rm = TRUE))

p10 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P10 = quantile(resultat, probs = 0.1, na.rm = TRUE))
  

departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)

classe_ptotal <- c(
  "Très bon" = "darkgreen",
  "Bon" = "lightgreen",
  "Moyen" = "yellow",
  "Médiocre" = "orange",
  "Mauvais"="red"
)

ptot_carte <- p90 %>%
  filter(code_parametre == "1350") %>%
  arrange(code_station_hydrobio) %>% 
  mutate(classe_ptot= case_when(... = 
                                      P90 <= 0.05 ~ "Très bon",
                                    P90 <= 0.2 ~ "Bon",
                                    P90 <= 0.5 ~ "Moyen",
                                    P90 <= 1 ~ "Médiocre",
                                    P90 > 1 ~ "Mauvais"
                                    
                                    
  ))


ptot_carte <- ptot_carte %>%
  mutate(classe_ptot =factor(classe_ptot,levels=c("Très bon","Bon","Moyen","Médiocre","Mauvais")))

gradient_ptot <- ptot_carte %>% 
  left_join(clean_ibd %>% 
              dplyr::select(code_station_hydrobio, longitude, latitude) %>% 
              distinct(),
            by = "code_station_hydrobio"
  ) 


ptot_sf<-st_as_sf(gradient_ptot, coords=c("longitude","latitude"),crs=4326)

ggplot() +
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = ptot_sf, aes(color = classe_ptot), size = 2) +
  scale_color_manual(values = classe_ptotal) +
  annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  coord_sf(xlim = c(-5.2, -1), ylim = c(47, 49), expand = FALSE) +
  labs(title = "Gradient des concentrations en phosphore total sur le territoire breton",
       color = "Classe d'état") +
  theme_minimal() +
  theme(legend.position = "bottom")



```

La pollution azotée, notamment les nitrates, stagne à un niveau très
élevé depuis 6 ans, c’est-à-dire 32,1 mg.L (percentile 90). La mesure de
la concentration en nitrates est complétée d’une mesure débitmétrique
car plus les débits sont importants plus les quantités en azote nitrique
sortant du bassin versant sont élevées. Les formes de l’azote les plus
toxiques sont l'ammonium (de part sa transformation aisée en ammoniac)
et les nitrites, produites notamment par le biais de réactions
acido-basique et oxydo-réductrices dans le cycle de l'azote, elles
feront donc parties des espèces chimiques étudiées
(<https://www.sciencedirect.com/science/article/abs/pii/S1382668918302540>).

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height=5, fig.align = 'center', fig.cap= " Fig.3 : Gradient de concentration en nitrates en Bretagne, autrice : Ilona Garcia"}

load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/80_donnees_globales_trans.rda")
load(file = "../Data/90_acp.rda")
load(file ="../Data/40_statistiques_descriptives.rda")

library(sf)
library(dplyr)
library(ggspatial)
library(ggplot2)
remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)

p90 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P90 = quantile(resultat, probs = 0.9, na.rm = TRUE))

p10 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P10 = quantile(resultat, probs = 0.1, na.rm = TRUE))
  

departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)


classe_nitt <- c(
  "Très bon" = "darkgreen",
  "Bon" = "lightgreen",
  "Hors classement"="red"
)

nitrates_carte <- p90 %>%
  filter(code_parametre == "1340") %>%
  arrange(code_station_hydrobio) %>% 
  mutate(classe_nitrates= case_when(... = 
                                      P90 <= 10 ~ "Très bon",
                                    P90 <= 50 ~ "Bon",
                                    P90 > 50 ~ "Hors classement"
                                   
                                    
  ))


nitrates_carte <- nitrates_carte %>%
  mutate(classe_nitrates=factor(classe_nitrates,levels=c("Très bon","Bon","Hors classement")))

gradient_nitrates <- nitrates_carte %>% 
  left_join(clean_ibd %>% 
              dplyr::select(code_station_hydrobio, longitude, latitude) %>% 
              distinct(),
            by = "code_station_hydrobio"
  ) 


nitrates_sf<-st_as_sf(gradient_nitrates, coords=c("longitude","latitude"),crs=4326)

ggplot() +
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = nitrates_sf, aes(color = classe_nitrates), size = 2) +
  scale_color_manual(values = classe_nitt) +
  annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  coord_sf(xlim = c(-5.2, -1), ylim = c(47, 49), expand = FALSE) +
  labs(title = "Gradient des concentrations en nitrates sur le territoire breton",
       color = "Classe d'état") +
  theme_minimal() +
  theme(legend.position = "bottom")


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height=5, fig.align = 'center', fig.cap= " Fig.4 : Gradient de concentration en azote ammoniacal en Bretagne, autrice : Ilona Garcia"}

load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/80_donnees_globales_trans.rda")
load(file = "../Data/90_acp.rda")
load(file ="../Data/40_statistiques_descriptives.rda")

library(sf)
library(dplyr)
library(ggspatial)
library(ggplot2)
remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)

p90 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P90 = quantile(resultat, probs = 0.9, na.rm = TRUE))

p10 <- parametres_physico %>% 
  group_by(code_station_hydrobio,code_parametre) %>% 
  summarise(P10 = quantile(resultat, probs = 0.1, na.rm = TRUE))
  

departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)

classe_nh4 <- c(
  "Très bon" = "darkgreen",
  "Bon" = "lightgreen",
  "Moyen" = "yellow",
  "Médiocre" = "orange",
  "Mauvais"="red"
)

ammonium_carte <- p90 %>%
  filter(code_parametre == "1335") %>%
  arrange(code_station_hydrobio) %>% 
  mutate(classe_ammonium= case_when(... = 
                                      P90 <= 0.1 ~ "Très bon",
                                    P90 <= 0.5 ~ "Bon",
                                    P90 <= 2 ~ "Moyen",
                                    P90 <= 5 ~ "Médiocre",
                                    P90 > 5 ~ "Mauvais"
                                    
                                    
  ))


ammonium_carte <- ammonium_carte %>%
  mutate(classe_ammonium=factor(classe_ammonium,levels=c("Très bon","Bon","Moyen","Médiocre","Mauvais")))

gradient_ammonium <- ammonium_carte %>% 
  left_join(clean_ibd %>% 
              dplyr::select(code_station_hydrobio, longitude, latitude) %>% 
              distinct(),
            by = "code_station_hydrobio"
  ) 


ammonium_sf<-st_as_sf(gradient_ammonium, coords=c("longitude","latitude"),crs=4326)

ggplot() +
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = ammonium_sf, aes(color = classe_ammonium), size = 2) +
  scale_color_manual(values = classe_nh4) +
   annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  coord_sf(xlim = c(-5.2, -1), ylim = c(47, 49), expand = FALSE) +
  labs(title = "Gradient des concentrations en ammonium sur le territoire breton",
       color = "Classe d'état") +
  theme_minimal() +
  theme(legend.position = "bottom")

```

La concentration en nitrates est globalement uniforme, contrairement à
l'ammonium dont la concentration s'accroit dans l'est de la région, de
manière similaire au gradient de qualité des cours d'eau bretons.

## Cartes des classes d’états I2M2 et IBD

La région étant fragmentée pour les différentes raisons énnoncées
précédemment, il est intéressant d'étudier l'évolution des notes I2M2 et
IBD au sein des différentes stations. [ANNONCER QU'ON VEUT FAIRE UNE
ETUDE SPATIALE ICI?]

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 8, fig.height=6, fig.align = 'center', fig.cap= " Fig.5 : Evolutions des notes I2M2 de chaque stations au cours du temps, autrice : Ilona Garcia" }

remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)
load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/50_chroniques_et_tendance.rda")


#On crée les couleurs par classe
couleursi2m2<-c(
  "Très bon" = "darkgreen",
  "Bon" = "lightgreen",
   "Moyen" = "yellow",
  "Médiocre"="orange",
  "Mauvais" = "red"
  
)

#On va regarder l'évolution de la classe d'i2m2 au cours du temps 
i2m2test <- i2m2 %>%
  mutate(classe_etat= case_when(... = 
                                resultat_indice > 0.665 ~ "Très bon",
                                resultat_indice > 0.443 ~ "Bon",
                                resultat_indice > 0.295 ~ "Moyen",
                                resultat_indice > 0.148 ~ "Médiocre",
                                TRUE                    ~ "Mauvais"

  ))

i2m2test<- i2m2test %>%
  mutate(classe_etat=factor(classe_etat,levels=c("Très bon","Bon","Moyen","Médiocre","Mauvais")))


#On teste avec facet_wrap

i2m2_sf<-st_as_sf(i2m2test, coords=c("longitude","latitude"),crs=4326)

departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)


ggplot() + 
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = i2m2_sf, aes(color = classe_etat), size = 2) +
  scale_color_manual(values = couleursi2m2) +
   annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  coord_sf(xlim = c(-5.2, -1), ylim = c(47, 49), expand = FALSE) +
  facet_wrap(~ as.factor(annee)) +
  labs(title = "Évolution des classes d'état I2M2 par année",
       color = "Classe d'état") +
  theme_minimal() +
  theme(legend.position = "bottom")
  

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 13, fig.height=10, fig.align = 'center', fig.cap= " Fig.6 : Evolutions des notes IBD de chaque stations au cours du temps, autrice : Ilona Garcia"}

remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)
load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/50_chroniques_et_tendance.rda")

couleursibd<-c(
  "Très bon" = "darkgreen",
  "Bon" = "lightgreen",
  "Moyen" = "yellow",
  "Médiocre"="orange",
  "Mauvais" = "red"
  
)

#On va regarder l'évolution de la classe d'i2m2 au cours du temps 
ibdtest <- ibd %>%
  mutate(classe_etat= case_when(... = 
                                  resultat_indice > 16.4 ~ "Très bon",
                                resultat_indice > 13.8 ~ "Bon",
                                resultat_indice > 10 ~ "Moyen",
                                resultat_indice > 5.9 ~ "Médiocre",
                                TRUE                    ~ "Mauvais"
                                
  ))

ibdtest<- ibdtest %>%
  mutate(classe_etat=factor(classe_etat,levels=c("Très bon","Bon","Moyen","Médiocre","Mauvais")))


ibd_sf<-st_as_sf(ibdtest, coords=c("longitude","latitude"),crs=4326)


departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)

ggplot() + 
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = ibd_sf, aes(color = classe_etat), size = 1) +
  scale_color_manual(values = couleursibd) +
   annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  coord_sf(xlim = c(-5.2, -1), ylim = c(47, 49), expand = FALSE) +
  facet_wrap(~ as.factor(annee)) +
  labs(title = "Évolution des classes d'état IBD par année",
       color = "Classe d'état") +
  theme_minimal() +
  theme(legend.position = "bottom")
  


```

En 2023, 43% des stations présentent un état "Moyen" selon l'indice
diatomées, contre 15% pour les macroinvertébrés, confirmant ainsi les
tendances de déclassement précédemment mises en évidence en Bretagne. La
majorité de ces stations se trouvent à l'est de la région.

# Objectif de l’étude

L’objectif de cette étude est d’analyser les réponses biologiques des
macroinvertébrés et diatomées benthiques en lien avec les différents
paramètres physico-chimiques retenues afin d’identifier des patterns
écologiques généraux des cours d’eau bretons. En considérant les
pressions constituants la construction de l’indice I2M2 et de les
données bibliographiques retenues concernants les communautés
diatomiques et macroinvertébrés, les éléments physico-chimiques
selectionnés sont les suivants :

-   Les matières azotées (nitrates, nitrites, ammonium)
-   Les matières organiques et oxydables (carbone organique)
-   Les matières phosphorées (phosphore total et othophosphates)
-   Les matières en suspension
-   L’acidification (pH)
    (<https://www.frontiersin.org/journals/water/articles/10.3389/frwa.2021.662765/full>)
    –\> MI
-   Conductivité
    (<https://www.frontiersin.org/journals/water/articles/10.3389/frwa.2021.662765/full>)
    –\> MI
-   Température –\> Rhone

L’étude se porte premièrement sur l'étude des indices biologiques I2M2
et IBD et deuxièmement sur les groupes taxonomiques.

# Matériels et méthodes

## Bancarisation des données

Les données sont extraites à partir d’Hub’eau, service proposé par Eau
France. Des API sont mis à disposition, ce qui favorise l’utilisation
des données pour leur traitement sur le logiciel R. Cela permet la
reproductibilité des scripts entre les utilisateurs.

## Sélection des données

### Prétraitement des indices biologiques

Après chargement des données complètes "macroinvertébrés", seules les
observations associées à l'I2M2 et ses métriques sont conservées.
L'exploration porte sur la période 2015-2023, en raison du transfert non
automatisé des données entre les portails SEEE et Hub’eau. Les données
relatives à l'IBD, appliqué en 2003, couvrent une période plus étendue
(2005-2023). Toutefois, les années 2005 à 2007 ont été exclues en raison
du nombre insuffisant de données, lié à la mise en oeuvre progressive
des réseaux de contrôle opérationnel à partir de 2007. Les campagnes
d'échantillonage sont ménées annuellement, en période d'étiage.
Toutefois, lorsque deux prélévements étaient constatés au cours de
l'année, avec deux résultats différents, le prélèvement le plus tardif
était conservé.

Le prétraitement est composé de plusieurs étapes telles que : selection
des indices et métriques, suppression des valeurs aberrantes **(annexe
formule)**, rennomage des variables pour l'uniformisation entre les jeux
de données, contrôle des doublons. Des valeurs manquantes peuvent être
présentes en raison de la fréquence de prélèvement qui n'est pas la même
selon le réseau ou d'une impossibilité de réalisation du prélèvement à
cause des conditions hydrologiques. Ces valeurs manquantes ne peuvent
pas être reconstituées et posent problème pour l'analyse. Afin de
limiter le nombre de valeurs manquantes, seules les stations présentant
au moins cinq années de données, non nécessairement consécutives, ont
été retenues pour l'analyse. Au terme de cela, 112 stations constituent
le jeu de données "macroinvertébrés" et 233 stations pour les diatomées.
Parmi les stations "macroinvertébrés", 57% des stations appartiennent au
réseau RCS, 16% RRP, 18% RCO, 6% RD, 2% non identifié. Dans le jeu de
données relatif aux diatomées, 29% des stations font parti du réseau
RCS, 19% au réseau RD, 16 % au réseau RCO, 7% au réseau RRP et 28% non
identifié [PRECISER QUE CELA EN FAIT UNE LIMITE A NOTRE ETUDE ICI?].

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 13, fig.height=10, fig.align = 'center', fig.cap= " Fig.7 : Chroniques des données I2M2, autrice : Ilona Garcia" }

library(ggplot2)
library(dplyr)
load(file = "../Data/10_donnees_pretraitees.rda")

#Préparation des données : présence/absence
data_presence <- clean_minv %>%
  filter(libelle_indice == "Indice Invertébrés Multimétrique (I2M2)") %>%
  group_by(code_station_hydrobio, annee) %>%
  summarise(presence = ifelse(n() > 0, 1, 0), .groups = "drop") # 1 si données, 0 sinon

#On joint les libellés des stations au dataframe
data_presence_complet <- data_presence %>%
  left_join(
    clean_minv %>%
      select(code_station_hydrobio, libelle_station_hydrobio) %>%
      distinct(),
    by = "code_station_hydrobio"
  )

#Création du graphique
ggplot(data_presence_complet,
       aes(
         x = as.factor(annee),
         y = factor(libelle_station_hydrobio),
         fill = as.factor(presence)
       )) +
  geom_tile(
    color = "white",
    size = 0.3,
    height = 0.9,
    width = 0.9
  ) +
  scale_fill_manual(values = c("0" = "#e0e0e0", "1" = "#1f77b4"), name = "Présence") +
  labs(title = "Présence des données I2M2 par station et par année",
       x = "Année",
       y = "Station") +
  theme_minimal(base_size = 10) +
  theme(
    plot.title = element_text(size = 12, face = "bold"),
    plot.subtitle = element_text(size = 9),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom",
    legend.title = element_text(size = 9),
    legend.text = element_text(size = 8)
  ) +
  scale_y_discrete(guide = guide_axis(n.dodge = 2)) +
scale_x_discrete(expand = c(0, 0))

```

#### Pressions physico-chimiques

Les données physico-chimiques sont également importées par le biais
d'Hub'eau et couvrent la période 2015-2024. Un protocole de
prétraitement similaire à celui appliqué aux données biologiques a été
appliqué aux données biologiques a été utilisé, avec l'ajout d'un filtre
spécifique à la fraction de l'eau sur laquelle les concentrations sont
mesurées. Après analyse des différentes fractions relevées pour chaque
paramètre (via un graphique similaire à celui de la Fig.7), seule la
fraction majoritaire a été conservée afin d'assurer l'homogénéité des
mesures. A l'issue de ces étapes de prétraitement, 232 stations ont été
retenues, correspondant aux stations I2M2 et IBD.

## Analyses

Les jeux de données sur lesquelles les analyses ont été réalisé sont les
suivants :

-   **clean_minv** : *code_station_hydrobio, libelle_station,
    code_indice, resultat_indice, date_prelevement, annee, longitude,
    lattitude, code_qualification.*
-   **clean_ibd :** *code_station_hydrobio, libelle_station,
    code_indice, resultat_indice, date_prelevement, annee, longitude,
    lattitude, code_qualification.*
-   **parametres_physico** : *code_station_hydrobio, libelle_station,
    code_parametres, resultat, date_prelevement, annee,
    code_qualification, code_fraction, code_support.*

### Analyses univariées

L’étude univariée des variables permet de décrire le jeu de données. Il
est important de mesurer la répartition des valeurs que peut prendre une
variable, notamment afin d’émettre des hypothèses pour la suite des
analyses. Dans le but annoncé précédemment, l’étude des distributions
des variables et les statistiques de tendance centrale et de dispersion
sont réalisées au cours de cette analyse.

### Analyses spatiales des tendances temporelles des indices

L'exploration des tendances temporelles des indices au sein de chaque
station permet d'identifier si les celles-ci sont significatives ou
aléatoires, donc d'avoir une vision synthétique de la direction des
évolutions des indices au sein des stations ainsi que de la variabilité
interannuelle. [biblio qui dit que les évolutions sont lentes]. Si la
Bretagne ne connait aucune évolution majeure de l'état des cours d'eau
vis-à-vis des indices biologiques étudiés, alors l'aggrégation des
valeurs en une statistique de tendance centrale sera possible.

La significativité de la tendance est obtenue grâce au test paramétrique
de Mann-Kendall (Mann, 1945, Kendall, 1975), efficace pour traiter les
tendances non linéaires, et robuste aux distributions non normales.

### Réalisation d'une "fenêtre glissante"

Les prélèvements physico-chimiques sont réalisés tout au long de
l'année, parfois plusieurs fois par mois. La variabilité inter-annuelle
étant négligé dans l'analyse, les résultats sont agrégés à l'issue de
cette étape. En effet, cette méthode permet de choisir la période
temporelle sur laquelle calculer une moyenne inter-annuelle pour chacun
des paramètres. Les critères sur lesquels se base cette sélection sont :

-   coefficient de corrélation

-   durée de la période où la correlation est significative

-   cohérence écologique

    Les étapes sont les suivantes :

-   création d'un dataframe (df), avec toutes les combinaisons de
    mois-début et mois-fin pour chaque paramètre (soit 78 combinaisons
    possibles).

-   réalisation d'un df avec les colonnes suivantes :
    *code_station_hydrobio, code_paramètre, annee, mois.*

-   calcule des moyennes mensuelles intra paramètres physico-chimiques
    au niveau de chaque station.

-   la fonction *calculer_indicateur* calcule la moyenne d'un paramètre
    sur une période donnée en regroupant les données par station et
    paramètre.

-   les résultats sont obtenus pour chaque combinaison de mois à l'aide
    de *map2_df*, en appliquant la fonction *calculer_indicateur* sur
    les données.

-   les moyennes des indices biologiques sont ensuite calculées par
    station et indice (supression du facteur temporel).

-   les résultats des moyennes calculées sont fusionnés avec les données
    initiales pour permettre les comparaisons.

-   les corrélations entre les paramètres physico-chimiques et les
    indices biologiques sont calculées à l'aide du test de Spearman.

-   les résultats des corrélations sont visualisés avec un graphique
    utilisant *ggplot2*, en affichant les corrélations significatives
    avec un point gris.

-   les noms des paramètres et des indices sont ajoutés pour une
    meilleure lisibilité, et les codes sont remplacés par des noms
    explicites.

-   un graphique final est créé pour représenter les corrélations en
    fonction des mois de début et de fin, en utilisant des couleurs pour
    indiquer la force de la corrélation (on appelle ce genre de
    graphique fenêtre glissante).

Une fois les moyennes calculées sur la période retenue, le dataframe
utilisé pour la suite des analyses est constitué de 232 lignes, où
chaque *code_station_hydrobio* se voit attribuer une seule valeur pour
chaque paramètre physico-chimique (14 colonnes correspondant aux 14
variables environnementales). Il s'agit du dataframe
*resultat_physico_final*, qui a été transposé par la suite pour la
réalisation des analyses suivantes.

### Analyses bivariées

Dans cette démarche exploratoire, on cherche à en savoir davantage sur
les relations entre les différentes variables. Les analyses bivariées
sont une aide à l'interpretation de l'ACP, qui guide la selection des
variables explicatives afin d'éviter notamment la multicolinéarité lors
de la modélisation.

Les analyses bivariées permettent d'évaluer le lien bivarié entre les
indices et les métriques et par la suite les paramètres
physico-chimiques deux à deux. Cela permet d'identifier les variables
plus ou moins indépendantes.

Des matrices des corrélation sont réalisées, calculant les corrélations
entre les indices et métriques puis entre paramètres physico-chimqiues,
grâce au test de corrélation de Spearman. Ce test est robuse en cas de
non normalité des distributions des variables et de relations non
linéaires entre elles.

### Analyses multivariées

L'analyse des composantes principales (ACP) est une méthode statistique
appartenant à la famille des analyses multivariées, c'est-à-dire
permettant de synthétiser les relations entre plusieurs variables
différentes. En effet, celle-ci résume l'information en quelques axes
principaux qui capturent la majorité de la variance totale du jeu de
données. Deux ACP ont été réalisé, une sur les variables d'indices
biologiques à l'échelle de la station et la seconde sur les paramètres
physico-chimiques, à la même échelle (à partir du jeu de données "").
L'objectif de cette analyse est de mettre en évidence des combianisons
de variables, les variables redondantes et celles qui sont les mieux
représentées dans les axes principaux. Pour terminer, cela permet de
dégager les composantes sous-jacentes qui structurent la Bretagne, au
regard des pressions physico-chimiques.

### Modèles linéaire généralisés

La modélisation par modèle linéaire généralisé permet d'analyser la
relation entre une variable dépendante et un ensemble de variables
explicatives, y compris lorsque la distribution de la variable s'écarte
de la normalité . La fonction de modélisation prendra en variable
dépendante les indices et métriques une à une, et en variables
explicatives les paramètres physico-chimiques, selectionnés selon les
analyses précédentes et des considérations écologiques théoriques.
L'objectif du modèle est d'observer quelles sont les variables qui ont
le plus d'influences sur les indices biologiques et les métriques et de
connaitre leur poids.

Le modèle repose sur une loi normale (ou gaussienne), avec une fonction
de lien "identité". Ceci implique la validation de certaines hypothèses
:

-   relation linéaire entre la variable dépendante et les predicteurs
-   l'indépendance des observations (vérification par le biais du
    graphique d'autocorrélation des résidus fonction *acf*)
-   Absence de multicolinéarité parmi les prédicteurs (affichage des
    coefficients VIF (Variance Inflation Factors, si ceux-ci sont
    supérieurs à 10 les variables sont multicolinéaires)
-   Absence d'influence extrême (observation graphique du modèle,
    estimation de la distance de cook)
-   l'homogénéité des variances des résidus (testée via le test de
    White)
-   la distribution normale des résidus (testée via le test de Shapiro)

Le jeu de données utilisé regroupe les indices biologiques, les
métriques et les paramètres physico-chimiques, consolidés à l’échelle
des stations. Afin de supprimer la dimension temporelle, une moyenne a
été calculée pour chaque variable. Ainsi, chaque station est représentée
par une seule valeur moyenne par paramètre, indice ou métrique,
permettant une analyse inter-stations. Le choix de la moyenne comme
statistique est justifié par une volonté d'étudier des patterns généraux
à l'échelle de chaque station.

Pour chaque modèle, la fonction stepAIC sera appliqué afin de retenir
seulement le modèle simplifié avec le critère d'information Aikaike le
plus élevé.

L'expression utilisée est la suivante (en prenant l'exemple de l'I2M2 en
tant que variable dépendante) :

*glm(I2M2 \~ O2dissous + NH4 + NO3 + Ptot, data =
df_global_sans_stations, family = gaussian(link = "identity"))*

# Résultats

## 1. Analyses univariées

### a) Indices biologiques

L'étude étant exploratoire, il est crucial d'examiner le comportement
global des variables. Les analyses sont réalisées sur les jeux de
données *clean_minv*, *clean_ibd et parametres_physico*. Les
distributions des variables seront décrites succinctement.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 8, fig.height= 5, fig.align = 'center', fig.cap= " Fig.8 : Distribution de l'I2M2 et ses métriques, autrice : Ilona Garcia"}

library(tidyverse)
load(file = "../Data/10_donnees_pretraitees.rda")


clean_minv_distrib <- clean_minv %>% 
         mutate(classe_I2M2 = case_when(
            resultat_indice > 0.665 ~ "Très bon",
            resultat_indice > 0.433 ~ "Bon",
            resultat_indice > 0.295 ~ "Moyen",
            resultat_indice >= 0.148 ~ "Médiocre",
            resultat_indice < 0.148  ~ "Mauvais" 
           
         ))
clean_minv_distrib$classe_I2M2 <- factor(clean_minv_distrib$classe_I2M2, levels = c("Très bon", "Bon", "Moyen", "Médiocre", "Mauvais"))

ggplot(clean_minv_distrib, aes(x = resultat_indice, fill = classe_I2M2)) +
  geom_histogram(bins = 10, color = "white", alpha = 0.7) + 
  scale_fill_manual(values = c(
    "Très bon" = "blue",
    "Bon"= "lightgreen",
    "Moyen"="yellow",
    "Médiocre"="orange",
    "Mauvais"="red"
  ))+
  facet_wrap(~ libelle_indice,labeller = label_wrap_gen(width = 20), scales = "free") +  # Un histogramme par métrique
  labs(title = "Distribution des valeurs des métriques de l'I2M2",
       x = "Valeur de la métrique",
       y = "Fréquence") +
  theme_minimal()




```

Les couleurs associées aux classes d'états de l'I2M2 sont appliquées à
chaque métrique pour faciliter la lecture.

D'après les résultats, la majorité des notes tendent vers le "Bon" et
"Très Bon" état selon la DCE. La plupart des métriques suivent une
distribution simlaire à celle de l'I2M2, légèrement symétrique, à
l'exception de la richesse taxonomique qui suit une distribution
normale. Les métriques d'ovoviviparité et de polyvoltinisme prennent de
multiple fois une valeur nulle, ce qui témoigne d'une mauvaise qualité
des masses d'eau au niveau de ces stations (qui se trouvent en majorité
en Ille-et-Vilaine).

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 5, fig.height= 5, fig.align = 'center', fig.cap= " Fig.9 : Distribution de l'IBD et de l'IPS, autrice : Ilona Garcia" }

library(tidyverse)
load(file = "../Data/10_donnees_pretraitees.rda")


clean_ibd_distrib <- clean_ibd %>% 
         mutate(classe_ibd = case_when(
            resultat_indice > 16.4 ~ "Très bon",
                                resultat_indice > 13.8 ~ "Bon",
                                resultat_indice > 10 ~ "Moyen",
                                resultat_indice > 5.9 ~ "Médiocre",
                                TRUE                    ~ "Mauvais"
           
         ))
clean_ibd_distrib$classe_ibd <- factor(clean_ibd_distrib$classe_ibd, levels = c("Très bon", "Bon", "Moyen", "Médiocre", "Mauvais"))

ggplot(clean_ibd_distrib, aes(x = resultat_indice, fill = classe_ibd)) +
  geom_histogram(bins = 10, color = "white", alpha = 0.7) + 
  scale_fill_manual(values = c(
    "Très bon" = "blue",
    "Bon"= "lightgreen",
    "Moyen"="yellow",
    "Médiocre"="orange",
    "Mauvais"="red"
  ))+
  facet_wrap(~ libelle_indice,labeller = label_wrap_gen(width = 20), scales = "free") +  # Un histogramme par métrique
  labs(title = "Distribution des valeurs des indices IBD et IPS",
       x = "Valeur de la métrique",
       y = "Fréquence") +
  theme_minimal()

```

En revanche, les notes d'indices relatifs aux diatomées classés comme
"Médiocre" et "Moyen" sont présentes en nombre largement supérieurs aux
notes d'I2M2. Cela illustre les conditions trophiques des milieux, qui
ne sont pas favorables au bon état écologique général.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 7, fig.height= 5, fig.align = 'center', fig.cap= " Fig.10 : Distribution inter-annuelle de l'indice I2M2 et ses métriques, autrice : Ilona Garcia"}
ggplot(clean_minv, aes (x=factor(annee), y = resultat_indice)) +
  geom_boxplot() +
  facet_wrap(~ libelle_indice, scales = "free_y") +
  labs(x = "Mois", y= "Valeur", title ="Distribution des métriques par année") +
  theme_bw()


```

Comme on peut l'observer, les notes sont relativement stables au cours
du temps, ce qui soutient l'hypothèse de faire une analyse
inter-stations, en aggrégeant les valeurs. Le même comportement est
observé pour les indices IBD et IPS.

### b) Paramètres physico-chimiques

[PARLER DES DITRIBUTIONS DES VARIABLES ?]

L'effet saisonnier est intéressant à étudier, notamment dans l'objectif
d'aggréger les valeurs en une statistique de tendance centrale telle
qu'une moyenne pour réprésenter des phénomènes généraux à l'échelle des
stations.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 10, fig.height= 5, fig.align = 'center', fig.cap= " Fig.11 : Distribution des variables environnementales au cours de l'année, autrice : Ilona Garcia"}

parametres_physico_mois <- parametres_physico %>% 
  group_by(libelle_parametre,mois) %>% 
  summarise(
    moy_mois=mean(resultat, na.rm =TRUE),
    med_mois=median(resultat, na.rm = TRUE),
    ecart_type_mois=sd(resultat, na.rm = TRUE),
    max_mois=max(resultat, na.rm =TRUE),
    min_mois=min(resultat, na.rm = TRUE)
  )


ggplot(parametres_physico, aes (x=factor(mois), y = resultat)) +
  geom_boxplot() +
  facet_wrap(~ libelle_parametre, scales = "free_y") +
  labs(x = "Mois", y= "Valeur", title ="Distribution des parametres par mois") +
  theme_bw()


```

Les concentrations sont relativement stables malgré les saisons, à
l'exception de la température et de l'oxygène dissous. De manière
similaire que pour les indices, cela soutient également l'idée
d'agrégger les valeurs.

## 2. Analyses spatiales des tendances temporelles

Afin de valider nos hypothèses sur l'inertie des indices biologiques en
Bretagne, et donc faire une aggrégation de manière similaire aux
paramètres physico-chimiques, les tendances à l'échelle de chaque
station sont étudiées.

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 5, fig.height= 5, fig.align = 'center', fig.cap= " Fig.12 : Carte des tendances des indices I2M2 et IBD en Bretagne : Ilona Garcia"}
library(tidyverse)
library(trend)
library(sf)
library(ggplot2)
library(scales)
remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)
library(ggspatial)

functions <- list.files(path = "R",
                        pattern = ".R$",
                        full.names = TRUE)

map(.x = functions,
    .f = source)

load(file = "../Data/10_donnees_pretraitees.rda")
source(file = "../R/mk_st_by_group.R")
source(file = "../R/Mann_kendall_div.R")


Tendances_multi <-mk_st_by_group(clean_minv,resultat_indice,code_indice,code_indice,code_station_hydrobio)
Tendance_i2m2 <- filter(Tendances_multi, code_indice==7613) %>% dplyr::select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_ASPT <-filter(Tendances_multi,code_indice==8057)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_OVI <-filter(Tendances_multi,code_indice==8055)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_POL <-filter(Tendances_multi,code_indice==8056)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_SHA <-filter(Tendances_multi,code_indice==8058)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_RIC <-filter(Tendances_multi,code_indice==8054)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)

i2m2 <- filter(clean_minv,code_indice==7613)
i2m2_et_trend <- left_join(i2m2,Tendance_i2m2,by="code_station_hydrobio")


i2m2_et_trend <- i2m2_et_trend %>%
  mutate(
    symbole = case_when(
      trend == "Increase" ~ "\u25B2",      # triangle vers le haut
      trend == "Decrease" ~ "\u25BC",    # triangle vers le bas
                             
    ),
    couleur = ifelse(mk_pvalue < 0.05, "red", "black"),
    taille = rescale(abs(sens_slope), to = c(1, 8))  # ajuste selon ton besoin
  )

i2m2_et_trend_sf <- st_as_sf(i2m2_et_trend, coords = c("longitude", "latitude"), crs = 4326 )


departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)


# Tracer la carte avec geom_sf
ggplot() +
  geom_sf(data = departement_breton, fill = "gray95", color = "white", size = 0.3) +
  geom_sf(data = i2m2_et_trend_sf) +
  geom_sf_text(
    data = i2m2_et_trend_sf,
    aes(label = symbole, color = couleur, size = taille),
    show.legend = FALSE
  ) +
  scale_color_identity() +
  scale_size_identity() +
  annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  theme_minimal() +
  labs(title = "Tendance des indices I2M2 par station",
       subtitle = "Taille de l'icone = pente de la tendance | Rouge = significatif (p < 0.05)",
       caption = "▲ : tendance croissante, ▼ : décroissante, ● : aucune")


```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width= 5, fig.height= 5, fig.align = 'center', fig.cap= " Fig.13 : Carte des tendances des indices I2M2 et IBD en Bretagne : Ilona Garcia" }

library(tidyverse)
library(trend)
library(sf)
library(ggplot2)
library(scales)
remotes::install_github("MaelTheuliere/COGiter")
library(COGiter)
library(ggspatial)

functions <- list.files(path = "R",
                        pattern = ".R$",
                        full.names = TRUE)

map(.x = functions,
    .f = source)

load(file = "../Data/10_donnees_pretraitees.rda")
source(file = "../R/mk_st_by_group.R")
source(file = "../R/Mann_kendall_div.R")


Tendances_donneesdiat<-mk_st_by_group(clean_ibd,resultat_indice,code_indice,code_indice,code_station_hydrobio)
Tendance_ibd <- filter(Tendances_donneesdiat, code_indice==5856) %>% select(code_station_hydrobio,trend,sens_slope,mk_pvalue)
Tendance_ips <-filter(Tendances_donneesdiat,code_indice==1022)%>%select(code_station_hydrobio,trend,sens_slope,mk_pvalue)

ibd <- filter(clean_ibd,code_indice==5856)
ibd_et_trend <- left_join(ibd,Tendance_ibd,by="code_station_hydrobio")

ibd_et_trend <- ibd_et_trend %>%
  mutate(
    symbole = case_when(
      trend == "Increase" ~ "\u25B2",      # triangle vers le haut
      trend == "Decrease" ~ "\u25BC",    # triangle vers le bas
                          
    ),
    couleur = ifelse(mk_pvalue < 0.05, "red", "black"),
    taille = rescale(abs(sens_slope), to = c(1, 8))  # ajuste selon ton besoin
  )

ibd_et_trend_sf <- st_as_sf(ibd_et_trend, coords = c("longitude", "latitude"), crs = 4326 )


departement_breton <- departements_metro_geo %>% 
  filter(DEP %in% c("22","29","35","56")) %>% 
  st_transform(crs = 4326)


# Tracer la carte avec geom_sf
ggplot() +
  geom_sf(data = departement_breton, fill = "gray95", color = "black", size = 0.3) +
  geom_sf(data = ibd_et_trend_sf) +
  geom_sf_text(
    data = ibd_et_trend_sf,
    aes(label = symbole, color = couleur, size = taille),
    show.legend = FALSE
  ) +
  scale_color_identity() +
  scale_size_identity() +
  annotation_scale(location = "br", line_width = .5) +
  annotation_north_arrow(location = "bl", height = unit(0.7, "cm"), width = unit(0.7, "cm")) +
  theme_minimal() +
  labs(title = "Tendance de l'indice IBD par station",
       subtitle = "Taille = pente de la tendance | Rouge = significatif (p < 0.05)",
       caption = "▲ : tendance croissante, ▼ : décroissante, ● : aucune")


```

Peu de stations présentent des tendances significatives, suggérant une
variabilité temporelle limitée. Un nombre faible de tendances
significatives est constaté pour les métriques de l'I2M2, notamment la
richesse taxonomique qui est la seule métrique qui ne croît dans aucune
station.

La variabilté temporelle sera donc négligée lors de l'étude, permettant
d'aborder une analyse inter-stations.

## Choix de la période temporelle sur laquelle agréger

Une fois la méthode de la fenêtre glissante établie, la graphique
suivant est obtenu :

```{r, echo=FALSE,results= 'hide', message=FALSE, warning=FALSE, fig.show='hide'}

source (file = "../R/calculer_indicateur.R")

#Constitution des combinaisons de mois : avoir toutes les combinaisons possibles
#entre le mois de début et le mois de fin
combin_mois <- expand.grid(1:12, 1:12) %>%
  set_names("mois_debut", "mois_fin") %>%
  filter(mois_debut <= mois_fin)

#Vérification
combin_mois %>%
  mutate(remp = 1) %>%
  pivot_wider(names_from = mois_fin,
              values_from = remp)

#Assemblage du jeu de données 

window_data <- expand.grid(stations_parametre,
                           code_pc,
                           2015:2024,
                           1:12) %>%
  set_names("code_station_hydrobio", "code_parametre", "annee", "mois")

mean_physico <- parametres_physico %>% 
  group_by(code_station_hydrobio,
         code_parametre,
         annee,
         mois) %>% 
  summarise(para_moy = mean(resultat, na.rm = TRUE))


donnees_jointure <- window_data %>% 
  left_join(y = mean_physico)


glimpse(window_data)


# test pour toutes les combinaisons de mois de début (.x) et de fin (.y)

resultat2 <- map2_df(
  .df = donnees_jointure,
  .f = calculer_indicateur,
  .var_mois = mois,
  .var_valeur = para_moy,
  .x = combin_mois$mois_debut,
  .y = combin_mois$mois_fin,
  code_station_hydrobio,
  code_parametre
)

indices_moy_par_sta <- clean_minv %>% 
  group_by(code_station_hydrobio,
           code_indice) %>% 
  summarise(indice_moy = mean(resultat_indice, na.rm = TRUE),
            .groups = "drop")

resultat_i2m2 <- resultat2 %>%
  rename(para_moy = moy) %>% 
  left_join(y = indices_moy_par_sta)
            
cor_i2m2 <- resultat_i2m2 %>% 
  drop_na() %>% 
  group_by(code_parametre,
           code_indice,
           debut,
           fin) %>% 
  summarise(correlation = cor.test(para_moy,
                              indice_moy,
                              method = "spearman")$estimate,
            p_value = cor.test(para_moy,indice_moy, method="spearman")$p.value,
            .groups = "drop"
            )

cor_i2m2 %>% 
  ggplot(aes(x = debut,
             y = fin,
             fill = correlation,
             col = correlation)) +
  geom_point(size = 3) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  scale_color_distiller(palette = "Spectral", direction = 1) +
  scale_x_continuous(breaks = 1:12) +
  scale_y_continuous(breaks = 1:12) +
  facet_grid(code_indice~code_parametre) +
  theme_bw() +
  theme(panel.grid.minor = element_blank()) +
  labs(x = "Mois de début",
       y = "Mois de fin")

indices_moy_par_sta_ibd <- clean_ibd %>% 
  group_by(code_station_hydrobio,
           code_indice) %>% 
  summarise(indice_moy = mean(resultat_indice, na.rm = TRUE),
            .groups = "drop")

  
```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=8, fig.cap= "Fig.14 = Fenêtre glissante des corrélations entre les paramètres physico-chimiques et l'indice I2M2 et ses métriques, autrice : Ilona Garcia"}

#Ajouter les noms
cor_i2m2_label <- cor_i2m2 %>%
  mutate(
    nom_parametre = case_when(
      code_parametre == "1301" ~ "T°",
      code_parametre == "1302" ~ "pH",
      code_parametre == "1303" ~ "Conductiv",
      code_parametre == "1305" ~ "MES",
      code_parametre == "1311" ~ "O2 dissous",
      code_parametre == "1312" ~ "Satur.O2",
      code_parametre == "1313" ~ "DBO5",
      code_parametre == "1335" ~ "NH4+",
      code_parametre == "1339" ~ "NO2-",
      code_parametre == "1340" ~ "NO3-",
      code_parametre == "1350" ~ "P total",
      code_parametre == "1433" ~ "PO4-",
      code_parametre == "1295" ~ "Turbidité",
      code_parametre == "1841" ~ "C organique",
      TRUE ~ code_parametre
    ),
    nom_indice = case_when(
      code_indice == "7613" ~ "I2M2",
      code_indice == "8054" ~ "RichesI2M2",
      code_indice == "8055" ~ "OvovivI2M2",
      code_indice == "8056" ~ "PolyvolI2M2",
      code_indice == "8057" ~ "ASPT",
      code_indice == "8058" ~ "H'",
      TRUE ~ code_indice
    ),
    nom_parametre = factor(nom_parametre, levels= c("NH4+","NO2-","NO3-","P total","PO4-","C organique","O2 dissous","Satur.O2","DBO5","MES","Turbidité","Conductiv","pH","T°")),
    nom_indice = factor(nom_indice, levels= c("I2M2","H'","RichesI2M2","OvovivI2M2","PolyvolI2M2","ASPT"))
  )


#Création du graphique
cor_i2m2_label %>% 
ggplot(aes(x = debut, 
           y = fin, 
           fill = correlation, 
           col = correlation)) +
  geom_point(size = 3) +
  geom_point(data = cor_i2m2_label %>% filter(p_value < 0.01),
             aes(x = debut, y = fin),
             fill = NA, color = "grey", size = 0.5) +
  scale_fill_distiller(palette = "Spectral", direction = 1) +
  scale_color_distiller(palette = "Spectral", direction = 1) +
  scale_x_continuous(breaks = seq(1, 12, by = 2)) +
  scale_y_continuous(breaks = seq(1, 12, by = 2)) +
    
  facet_grid(nom_indice ~ nom_parametre) +
    

  theme_bw() +
  theme(
    panel.grid.major = element_blank(),  # suppression du quadrillage principal
    panel.grid.minor = element_blank(),
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  ) +
    

  labs(
    x = "Mois de début",
    y = "Mois de fin",
    fill = "Corrélation",
    color = "Corrélation"
  )

```

D'après le graphique ci-dessous, trois periodes peuvent être distinguées
:

-   Nitrates : janvier à mars

-   Oxygène dissous et taux de saturation en oxygène : mai à décembre

-   Autres : annuelle

Les périodes présentant les corrélations significatives les plus fortes
avec les indices biologiques ont été retenues pour l’analyse. La
métrique de richesse taxonomique n’a pas été considéré dans ce choix. La
période de janvier à mars a notamment été sélectionnée pour les
nitrates, car elle correspond à la phase de lessivage des sols liée aux
précipitations hivernales, entraînant un transfert important de nitrates
issus des pratiques agricoles vers les cours d’eau. Les variables
physico-chimiques ont ainsi été agrégées en calculant leur moyenne sur
ces périodes spécifiques, afin de refléter au mieux les conditions
environnementales et donc les pressions étudiées.

## Selection des variables pour la modélisation

En analysant la structure interne des variables biologiques par le biais
de la matrice de corrélations, les métriques qui réagissent davantage à
la dégradation qualité de l'habitat sont les moins corrélées à l'I2M2.
De plus, elles contribuent très peu à la construction de l'axe F1, dont
les variables les plus contributives sont l'I2M2, le polyvoltinisme,
l'ASPT et l'ovoviviparité. Elles sont donc peu représentée dans cet axe
et donnent des informations convergentes, puisque la diversité de
Shannon est très liée à la varitété. Les métriques contributives de
l'axe F1 sont très covariantes, révélant les scores très dépendant les
un des autres.

D'après les résultats, l'I2M2 et l'IBD sont légèrement corrélés et donc
ne sont pas entièrement indépendants. Cela peut indiquer des réponses
biologiques à des pressions similaires.

```{r, echo=FALSE, message=FALSE, warning=FALSE,results= 'hide', message=FALSE, warning=FALSE, fig.show='hide' }
library(FactoMineR)
library(devtools)
library(factoextra)
library(dplyr)
library(tidyverse)

load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/70_choix_parametre.rda")
load(file = "../Data/80_donnees_globales_trans.rda")

i2m2_ibd <- i2m2_wide %>% 
  left_join(ibd_wide, by = "code_station_hydrobio") %>% 
  dplyr::select(`7613`:`5856`)

donnees_centrees_reduites_bio <- scale(i2m2_ibd,center=TRUE,scale=TRUE)

resultat_acp_bio<- PCA(donnees_centrees_reduites_bio, graph=TRUE)
#print(resultat_acp_bio)
valeurspropres_bio<- resultat_acp_bio$eig
#valeurspropres_bio

label_bio <- c("7613" = "I2M2",
               "8054" = "RichesI2M2",
               "8055" = "OvovivI2M2",
               "8056" = "PolyvolI2M2",
               "8057" = "ASPT",
               "8058" = "H'",
               "5856" = "IBD",
               "1022" = "IPS"
  
)

old_names_bio <- rownames(resultat_acp_bio$var$coord)
new_names_bio <- old_names_bio
new_names_bio[old_names_bio %in% names(label_bio)] <- label_bio[old_names_bio[old_names_bio %in% names(label_bio)]]


#barplot(valeurspropres_bio[,2],names.arg=1:nrow(valeurspropres_bio),
        #main="Pourcentage de la variance expliquée par chaque composante",
        #xlab="Composantes principales",
        #ylab="Pourcentage de variance expliquée",
        #col="steelblue")
#Add connected line segments to the plot
#lines(x=1:nrow(valeurspropres_bio),valeurspropres_bio[,2],
      #type="b", pch=19, col="red")

resultat_acp_bio$var$coord <- `rownames<-`(resultat_acp_bio$var$coord, new_names_bio)
resultat_acp_bio$var$contrib <- `rownames<-`(resultat_acp_bio$var$contrib, new_names_bio)
resultat_acp_bio$var$cos2 <- `rownames<-`(resultat_acp_bio$var$cos2, new_names_bio)
resultat_acp_bio$var$cor <- `rownames<-`(resultat_acp_bio$var$cor, new_names_bio)

fviz_pca_var(resultat_acp_bio,
             col.var="cos2",
             gradient.cols=c("deeppink", "maroon","navy"),
             repel=TRUE,
             title="Cercle de Corrélation des Variables")
#fviz_contrib(resultat_acp_bio,choice="var", axes=1, top = 10)
#fviz_contrib(resultat_acp_bio,choice="var", axes=2, top = 10)
#fviz_contrib(resultat_acp_bio,choice="var", axes=3, top = 10)

```

```{r,echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.width=6, fig.height=5, fig.cap= "Fig.15 = Analyse des composantes principales des indices biologiques, autrice : Ilona Garcia" }

fviz_pca_var(resultat_acp_bio,
             col.var="cos2",
             gradient.cols=c("deeppink", "maroon","navy"),
             repel=TRUE,
             title="Cercle de Corrélation des Variables")
```

Par le biais de l'ACP sur les paramètres physico-chimiques, le gradient
de pression s'opposant au gradient d'oxygénation se dégage nettemment.
Celui-ci est majoritairement contribué par les nitrites, l'amonium, le
phosphore total, la DBO5, la turbidité, la conductivité et les matières
en suspension. Les nitrates sont très peu représentés dans l'axe
principale, contrairement aux autres nutriments azotés. De plus, les
nitrates sont peu corrélés aux autres éléments azotés et phosphorés.
[EXPLICATION AVEC CYCLE DE L'AZOTE ? CONCENTRATION ELEVEE CONTINUE EN
BRETAGNE ?)

```{r, echo=FALSE, message=FALSE, warning=FALSE,results= 'hide', message=FALSE, warning=FALSE, fig.show='hide' }

library(FactoMineR)
library(devtools)
library(factoextra)
library(dplyr)
library(tidyverse)

load(file = "../Data/10_donnees_pretraitees.rda")
load(file = "../Data/70_choix_parametre.rda")
load(file = "../Data/80_donnees_globales_trans.rda")


label_physico <- c(
  "1301" = "T°",
  "1302" = "pH",
  "1303" = "Conductiv",
  "1305" = "MES",
  "1311" = "O2 dissous",
  "1312" = "Satur.O2",
  "1313" = "DBO5",
  "1335" = "NH4+",
  "1339" = "NO2-",
  "1340" = "NO3-",
  "1350" = "P total",
  "1433" = "PO4-",
  "1295" = "Turbidité",
  "1841" = "C organique")

acp_physico <- physico_wide %>%
  dplyr::select(`1295`:`1841`)

donnees_centrees_reduites_pc_2 <- scale(acp_physico,center=TRUE,scale=TRUE)
resultat_acp_physico_2<- PCA(donnees_centrees_reduites_pc_2, graph=TRUE)
print(resultat_acp_physico_2)
valeurspropres_pc_2<- resultat_acp_physico_2$eig
valeurspropres_pc_2

old_names <- rownames(resultat_acp_physico_2$var$coord)
new_names <- old_names
new_names[old_names %in% names(label_physico)] <- label_physico[old_names[old_names %in% names(label_physico)]]

resultat_acp_physico_2$var$cos2 <- `rownames<-`(resultat_acp_physico_2$var$cos2, new_names)


#barplot(valeurspropres_pc_2[,2],names.arg=1:nrow(valeurspropres_pc_2),
        #main="Pourcentage de la variance expliquée par chaque composante",
        #xlab="Composantes principales",
        #ylab="Pourcentage de variance expliquée",
        #col="steelblue")
#Add connected line segments to the plot
#lines(x=1:nrow(valeurspropres_pc_2),valeurspropres_pc_2[,2],
      #type="b", pch=19, col="red")

resultat_acp_physico_2$var$coord <- `rownames<-`(resultat_acp_physico_2$var$coord, new_names)
resultat_acp_physico_2$var$contrib <- `rownames<-`(resultat_acp_physico_2$var$contrib, new_names)
resultat_acp_physico_2$var$cos2 <- `rownames<-`(resultat_acp_physico_2$var$cos2, new_names)
resultat_acp_physico_2$var$cor <- `rownames<-`(resultat_acp_physico_2$var$cor, new_names)

fviz_pca_var(resultat_acp_physico_2,
             col.var="cos2",
             gradient.cols=c("deeppink", "maroon","navy"),
             repel=TRUE,
             title="Cercle de Corrélation des Variables")


#fviz_contrib(resultat_acp_physico_2,choice="var", axes=1, top = 10)
#fviz_contrib(resultat_acp_physico_2,choice="var", axes=2, top = 10)
#fviz_contrib(resultat_acp_physico_2,choice="var", axes=3, top = 10)

```

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.width=6, fig.height=5, fig.cap= "Fig.16 = Analyse des composantes principales des paramètres physico-chimiques, autrice : Ilona Garcia"}

fviz_pca_var(resultat_acp_physico_2,
             col.var="cos2",
             gradient.cols=c("deeppink", "maroon","navy"),
             repel=TRUE,
             title="Cercle de Corrélation des Variables")

```

Les variables explicatives retenues pour la modélisation ont été
sélectionnées en fonction de leur contribution aux axes de l’ACP, de
l’absence de colinéarité excessive, ainsi que de leur pertinence
écologique. L’ammonium, forme azotée la plus toxique, a été conservé,
tout comme les nitrates, fortement représentatifs des apports agricoles
diffus caractéristiques du contexte breton. Le phosphore total a été
retenu comme indicateur principal de la pression phosphorée, en raison
de sa forte contribution au gradient de l’axe 1 de l’ACP. Enfin,
l’oxygène dissous a été sélectionné en tant qu’indicateur de la qualité
globale du milieu.

## L'influence des variables selectionnées sur les indices et métriques

La modélisation des réponses de chaque métriques était automatique grâce
à la création d'une fonction de modélisation, où la variable dépendante
change. La démarche sera détaillée pour l'indice I2M2 puis les résultats
seront synthétisés en un tableau.

### Modélisation de la réponse de l'I2M2

Après simplification du modèle avec la fonction stepAIC du package MASS,
les quatres variables selectionnées sont retenues dont trois ont un
effet significatif sur l'I2M2. Il s'agit de l'oxygène dissous,
l'ammonium et le phosphore total.

Afin de valider l'hypothèse de non multicolinéarité, les coeffcients VIF
sont calculés :

```{r, echo=FALSE, message=FALSE, warning=FALSE, results='markup'}

load(file = "../Data/80_donnees_globales_trans.rda")
library(car)
library(MASS)
library(tidyverse)
library(sjPlot)
library(lmtest)


# On renomme les variables
df_global <- df_global %>% 
  rename(I2M2 = `7613`,
         richesI2M2 = `8054`,
         ovovivI2M2 = `8055`,
         polyvolI2M2 = `8056`,
         ASPT = `8057`,
         ShannonI2M2 = `8058`,
         IPS = `1022`,
         IBD = `5856`,
         turbidité = `1295`,
         Temp = `1301`,
         pH = `1302`,
         conductiv = `1303`,
         MES = `1305`,
         O2dissous = `1311`,
         SaturO2 = `1312`,
         DBO5 = `1313`,
         NH4 = `1335`,
         NO2 = `1339`,
         NO3 = `1340`,
         Ptot = `1350`,
         PO4 = `1433`,
         Corga = `1841`)

#On garde seulement les variables numériques
df_global_sans_stations <- df_global %>% 
  dplyr::select(I2M2:Corga)

model_normal_non_transformées <- glm(I2M2 ~
                                       O2dissous +
                                       NH4 +
                                       NO3 +
                                       Ptot,
                                     data = df_global_sans_stations,
                                     family = gaussian(link = "identity"))

model_simplifié <- MASS::stepAIC(model_normal_non_transformées)

vif(model_simplifié)

```

Les résultats sont tous inférieurs à cinq, le critère de non
multicolinéarité est respecté.

A la suite de cela, les test d'homoscédasticité et normalité des résidus
sont réalisés, à l'aide des test associés.

```{r,echo=FALSE, message=FALSE, warning=FALSE, results='markup'}

bptest(model_simplifié, ~fitted(model_normal_non_transformées) + I(fitted(model_normal_non_transformées)^2)) # test de white, variance constante

shapiro.test(residuals(model_simplifié)) #si pvalue < 0,05 ce n'est pas normal

```

La p-value étant supérieure à 0,05 dans les deux cas, les hypothèses
d'homoscédasticité et normalité sont validées.

Par conséquent, on peut valider le modèle et tracer les graphiques
associés.#

```{r, echo=FALSE, message=FALSE, warning=FALSE, fig.align='center', fig.width=6, fig.height=5, fig.cap= "Fig.17 = Graphiques illustrants le modèle , autrice : Ilona Garcia" }
plot(model_simplifié)

#sjPlot::plot_model(model_simplifié, type = "pred",terms= ("NH4"), title = "Effets ammonium  sur l'I2M2")
#sjPlot::plot_model(model_simplifié, type = "pred",terms= ("O2dissous"), title = "Effets de l'oxygène dissous  sur l'I2M2")
#sjPlot::plot_model(model_simplifié, type = "pred",terms= ("NO3"), title = "Effets des nitrates sur l'I2M2")
#sjPlot::plot_model(model_simplifié, type = "pred",terms= ("Ptot"), title = "Effets du phosphore total sur l'I2M2")
```

### Tableau récapitulatif

```{r, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

load(file = "../Data/80_donnees_globales_trans.rda")

library(car)
library(MASS)
library(tidyverse)
library(sjPlot)
library(lmtest)
library(DT)


functions <- list.files(path = "../R",
                        pattern = ".R$",
                        full.names = TRUE)

map(.x = functions,
    .f = source)


df_global <- df_global %>% 
  rename(I2M2 = `7613`,
         richesI2M2 = `8054`,
         ovovivI2M2 = `8055`,
         polyvolI2M2 = `8056`,
         ASPT = `8057`,
         ShannonI2M2 = `8058`,
         IPS = `1022`,
         IBD = `5856`,
         turbidité = `1295`,
         Temp = `1301`,
         pH = `1302`,
         conductiv = `1303`,
         MES = `1305`,
         O2dissous = `1311`,
         SaturO2 = `1312`,
         DBO5 = `1313`,
         NH4 = `1335`,
         NO2 = `1339`,
         NO3 = `1340`,
         Ptot = `1350`,
         PO4 = `1433`,
         Corga = `1841`)

#On garde seulement les variables numériques
df_global_sans_stations <- df_global %>% 
  dplyr::select(I2M2:Corga) 


mes_metriques <- names(df_global_sans_stations)[1:8]

res <- map_df(.x = mes_metriques,
              .f = caler_modele,
              df = df_global_sans_stations)

res_large <- res %>% 
  pivot_wider(names_from = variable,
              values_from = coef)


```

```{r, echo=FALSE}

library(DT)

res_large <- res %>% 
  pivot_wider(names_from = variable,
              values_from = coef)
datatable(res_large)
```

D'après les résultats, les indices et métriques liés à l'I2M2, à
l'exception de la diversité de Shannon et la richesse taxonomique, sont
sensibles à l'augmentation de la teneur en oxygène dissous dans l'eau,
démontrant l'importance de cet élement pour maintenir un cours d'eau en
bon état vis à vis des macro-invertébrés.

Tous les indices et métriques réagissent à l'augmentation de la
concentration en ammonium, à l'exception de la richesse taxonomique,
démontrant l'effet toxique pour les macroinvertébrés et diatomées
sensibles à ce genre de pollution impliquant une baisse de la note de
l'indice. En effet, à partir d'un certain seuil, cet élement peut
modifier la diversité et l'abondance des macro-invertébrés dans les
cours d'eau, ajouté d'une augmentation de la présence de taxons
tolérants tels que *Gammarus pulex*. Certaines diatomées ont également
un seuil, 100M, à partir duquel est observée une diminution de la
croissance ([soucre]. Les nitrates présents de manière continue en
Bretagne, moins toxiques que l'ammonium, ont un poids relativement
faible sur les réponses biologiques.

En remplçant l'ammonium par les nitrites en tant que variable
explicative du modèle, les effets se révèlent être significatifs sur les
indices et métriques, tout autant que l'ammonium.

Il est intéressant de noter que le phosphore total est le seul élement
suscitant une réponse de la richesse taxonomique, qui diminue lorsque ce
dernier augmente. **[SOURCE]**

D'après l'article *Multi-decadal improvements in the ecological quality
of European rivers are not consistently reflected in biodiversity
metrics[NOM]* , à l'échelle des pays de l'Europe, c'était l'indice de
Shannon et la richesse taxonomique qui montrait la relation la plus
forte aux changements de la qualité de l'eau. Ceci peut expliquer le
manque de réaction vis à vis de ces métriques tout au long des
différentes analyses.
